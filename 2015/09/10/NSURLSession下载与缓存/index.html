<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
    

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.4"/>




  <meta name="keywords" content="Hexo,next" />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.4" />


<meta name="description" content="NSURLSessionä¸‹è½½ä¸ç¼“å­˜iOS9è¦æ±‚ç½‘ç»œè¯·æ±‚éœ€è¦ä½¿ç”¨NSURLSession,é‚£ä¹ˆæœ¬ç¯‡æ–‡ç« å°±ä½¿ç”¨NSURLsessionæ¥å®ç°è§†é¢‘çš„ä¸‹è½½,å›¾ç‰‡çš„ä¸‹è½½ã€å–æ¶ˆä¸‹è½½ã€æ¢å¤ä¸‹è½½å’Œç¼“å­˜åŠŸèƒ½ï¼ŒæœŸæœ›ä¸å¤§å®¶ä¸€èµ·å­¦ä¹ ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="NSURLSessionä¸‹è½½ä¸ç¼“å­˜">
<meta property="og:url" content="http://yoursite.com/2015/09/10/NSURLSessionä¸‹è½½ä¸ç¼“å­˜/index.html">
<meta property="og:site_name" content="å¼ å¤©ç¦">
<meta property="og:description" content="NSURLSessionä¸‹è½½ä¸ç¼“å­˜iOS9è¦æ±‚ç½‘ç»œè¯·æ±‚éœ€è¦ä½¿ç”¨NSURLSession,é‚£ä¹ˆæœ¬ç¯‡æ–‡ç« å°±ä½¿ç”¨NSURLsessionæ¥å®ç°è§†é¢‘çš„ä¸‹è½½,å›¾ç‰‡çš„ä¸‹è½½ã€å–æ¶ˆä¸‹è½½ã€æ¢å¤ä¸‹è½½å’Œç¼“å­˜åŠŸèƒ½ï¼ŒæœŸæœ›ä¸å¤§å®¶ä¸€èµ·å­¦ä¹ ã€‚">
<meta property="og:updated_time" content="2015-12-11T03:33:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="NSURLSessionä¸‹è½½ä¸ç¼“å­˜">
<meta name="twitter:description" content="NSURLSessionä¸‹è½½ä¸ç¼“å­˜iOS9è¦æ±‚ç½‘ç»œè¯·æ±‚éœ€è¦ä½¿ç”¨NSURLSession,é‚£ä¹ˆæœ¬ç¯‡æ–‡ç« å°±ä½¿ç”¨NSURLsessionæ¥å®ç°è§†é¢‘çš„ä¸‹è½½,å›¾ç‰‡çš„ä¸‹è½½ã€å–æ¶ˆä¸‹è½½ã€æ¢å¤ä¸‹è½½å’Œç¼“å­˜åŠŸèƒ½ï¼ŒæœŸæœ›ä¸å¤§å®¶ä¸€èµ·å­¦ä¹ ã€‚">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'hide'
  };
</script>

    <title> NSURLSessionä¸‹è½½ä¸ç¼“å­˜ // å¼ å¤©ç¦ </title>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->




<div class="container one-column page-post-detail">
    <div class="headband"></div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">å¼ å¤©ç¦</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-home"></i> <br />
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-categories"></i> <br />
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-archives"></i> <br />
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-tags"></i> <br />
            æ ‡ç­¾
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
<form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'b7iqRs3RWh8rQLW-PNvz','2.0.0');
</script>

<div class="site-search-toggle"></div>
    </div>
  
</nav>


        </div>
    </header>

    <main id="main" class="main">
        <div class="main-inner">
            <div id="content" class="content">
                

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              NSURLSessionä¸‹è½½ä¸ç¼“å­˜
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          å‘è¡¨äº
          <time itemprop="dateCreated" datetime="2015-09-10T10:00:25+08:00" content="2015-09-10">
            2015-09-10
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><p>NSURLSessionä¸‹è½½ä¸ç¼“å­˜<br>iOS9è¦æ±‚ç½‘ç»œè¯·æ±‚éœ€è¦ä½¿ç”¨NSURLSession,é‚£ä¹ˆæœ¬ç¯‡æ–‡ç« <br>å°±ä½¿ç”¨NSURLsessionæ¥å®ç°è§†é¢‘çš„ä¸‹è½½,å›¾ç‰‡çš„ä¸‹è½½ã€å–æ¶ˆä¸‹è½½ã€æ¢å¤ä¸‹<br>è½½å’Œç¼“å­˜åŠŸèƒ½ï¼ŒæœŸæœ›ä¸å¤§å®¶ä¸€èµ·å­¦ä¹ ã€‚</p>
<a id="more"></a>
<p>NSURLSessionConfiguration(å‚æ•°é…ç½®ç±»)</p>
<p>NSURLSessionçŠ¶æ€åŒæ—¶å¯¹åº”ç€å¤šä¸ªè¿æ¥,ä¸åƒä¹‹å‰ä½¿ç”¨å…±äº«çš„ä¸€ä¸ªå…¨å±€çŠ¶æ€ã€‚ä¼šè¯æ˜¯é€šè¿‡å·¥å‚æ–¹æ³•ï¼ˆç±»æ–¹æ³•)æ¥åˆ›å»ºå¯¹è±¡<br>NSURLSessionConfigurationã€‚</p>
<p>æ€»å…±æœ‰ä¸‰ç§ä¼šè¯ï¼š</p>
<ul>
<li><p>1.defaultSessionConfiguration é»˜è®¤çš„ï¼Œè¿›ç¨‹å†…ä¼šè¯</p>
</li>
<li><p>2.ephemeralSessionConfigurationçŸ­æš‚çš„ï¼ˆå†…<br>å­˜ï¼‰ï¼Œè¿›ç¨‹å†…ä¼šè¯</p>
</li>
<li><p>3.backgroundSessionConfigurationWithIdentifieråå°ä¼šè¯</p>
</li>
</ul>
<p>ç›¸å…³å±æ€§</p>
<pre><code><span class="comment">//åå°ä»»åŠ¡çš„æ ‡è¯†ç¬¦</span>

<span class="keyword">@property</span> (nullable, <span class="keyword">readonly</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *<span class="keyword">id</span> entifier;

<span class="comment">//ç¼“å­˜çš„ç­–ç•¥</span>

<span class="keyword">@property</span> <span class="built_in">NSURLRequestCachePolicy</span> requestCachePolicy;

<span class="comment">//è¯·æ±‚è¶…æ—¶æ—¶é•¿</span>

<span class="keyword">@property</span> <span class="built_in">NSTimeInterval</span> timeoutIntervalForRequest;

<span class="comment">//ç½‘ç»œæœåŠ¡ç±»å‹</span>

<span class="keyword">@property</span> <span class="built_in">NSURLRequestNetworkServiceType</span> networkServiceType;

<span class="comment">//æ˜¯å¦åœ¨éæ— çº¿çš„æƒ…å†µä¸‹è¯·æ±‚ç½‘ç»œ</span>

<span class="keyword">@property</span> <span class="built_in">BOOL</span> allowsCellularAccess;
</code></pre><h4 id="æ‰‹åŠ¨ä¸‹è½½è§†é¢‘">æ‰‹åŠ¨ä¸‹è½½è§†é¢‘</h4><h4 id="æ­¥éª¤ï¼š">æ­¥éª¤ï¼š</h4><p>åœ¨Info.plistä¸­æ·»åŠ <code>NSAppTransportSecurity</code>ç±»å‹Dictionaryã€‚<br>åœ¨<code>NSAppTransportSecurity</code>ä¸‹æ·»åŠ <code>NSAllowsArbitraryLoads</code>ç±»å‹Boolean,å€¼è®¾ä¸ºYES;<br>Xcode7éœ€è¦æ·»åŠ æ­¤æ¡æ”¯æŒhttp</p>
<p>åœ¨å·¥ç¨‹å†…å¼•å…¥<code>AVFoundation</code>æ¡†æ¶ï¼Œå¹¶åœ¨ç›¸å…³ç±»å¼•å…¥AVKitã€AVFoundationå¤´æ–‡ä»¶;</p>
<p>éµå®ˆ<code>NSURLSessionDelegate</code>ï¼Œ<code>NSURLSessionDownloadDelegate</code>åè®®ï¼›<br>å‡†å¤‡ä¸€ä¸ªMP4æ ¼å¼çš„urlï¼Œè¿›è¡Œä¸‹è½½ï¼›<br>å°†ä¸‹è½½å®Œæˆçš„è§†é¢‘èµ„æºå­˜å…¥æœ¬åœ°ï¼Œå¹¶è¿›è¡Œæ’­æ”¾ã€‚</p>
<h4 id="å£°æ˜ç›¸å…³å±æ€§">å£°æ˜ç›¸å…³å±æ€§</h4><pre><code><span class="comment">//ä¸‹è½½ä»»åŠ¡  </span>
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">NSURLSessionDownloadTask</span> *downTask;  

<span class="comment">//ç½‘ç»œä¼šè¯  </span>
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">NSURLSession</span> * downLoadSession;
</code></pre><h4 id="é…ç½®ç›¸å…³å‚æ•°å¹¶ä¸‹è½½">é…ç½®ç›¸å…³å‚æ•°å¹¶ä¸‹è½½</h4><pre><code>    <span class="comment">//å‚æ•°è®¾ç½®ç±»  ç®€å•çš„ç½‘ç»œä¸‹è½½ä½¿ç”¨             </span>
defaultSessionConfigurationå³å¯
<span class="built_in">NSURLSessionConfiguration</span>          *sessionConfig =        
[<span class="built_in">NSURLSessionConfiguration</span>
defaultSessionConfiguration];

 <span class="comment">//åˆ›å»ºç½‘ç»œä¼šè¯  </span>
 <span class="keyword">self</span><span class="variable">.downLoadSession</span> = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:sessionConfig delegate:<span class="keyword">self</span> delegateQueue:[<span class="built_in">NSOperationQueue</span> new]];


 <span class="comment">//æ•°æ®è¯·æ±‚  </span>
 <span class="comment">/*
  *@param URL èµ„æºurl  
  *@param timeoutInterval è¶…æ—¶æ—¶é•¿
  */</span>
 <span class="built_in">NSURLRequest</span> *imgRequest = [<span class="built_in">NSURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="built_in">MP3URL</span>] cachePolicy:<span class="number">5</span> timeoutInterval:<span class="number">60.</span>f];

 <span class="comment">//åˆ›å»ºä¸‹è½½ä»»åŠ¡  </span>
 <span class="keyword">self</span><span class="variable">.downTask</span> = [<span class="keyword">self</span><span class="variable">.downLoadSession</span> downloadTaskWithRequest:imgRequest];

 <span class="comment">//å¯åŠ¨ä¸‹è½½ä»»åŠ¡  </span>
 [<span class="keyword">self</span><span class="variable">.downTask</span> resume];
</code></pre><h4 id="å®ç°ä»£ç†æ–¹æ³•">å®ç°ä»£ç†æ–¹æ³•</h4><pre><code>  <span class="preprocessor">#pragma mark ä¸‹è½½è¿‡ç¨‹</span>

  -(<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)sessiondownloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask didWriteData:(int64_t)bytesWritten totalBytesWritten:(int64_t)totalBytesWritten totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite
{
   <span class="comment">//è·å–ä¸‹è½½è¿›åº¦</span>
  <span class="keyword">double</span> currentProgress = totalBytesWritten / (<span class="keyword">double</span>)totalBytesExpectedToWrite;

  <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^{

   <span class="comment">//è¿›è¡ŒUIæ“ä½œ  è®¾ç½®è¿›åº¦æ¡</span>

    <span class="keyword">self</span><span class="variable">.downLoadProgress</span><span class="variable">.progress</span> = currentProgress;

});

  <span class="preprocessor">#pragma mark ä¸‹è½½å®Œæˆ æ— è®ºæˆåŠŸå¤±è´¥</span>

 -(<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session task: (<span class="built_in">NSURLSessionTask</span> *)task didCompleteWithError:(<span class="built_in">NSError</span> *)error
 {

    <span class="built_in">NSLog</span>(<span class="string">@" function == %s, line == %d, error ==  %@"</span>,__FUNCTION__,__LINE__,error);

 }
   <span class="preprocessor">#pragma mark - ä¸‹è½½æˆåŠŸ è·å–ä¸‹è½½å†…å®¹</span>
 -(<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session   downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask didFinishDownloadingToURL:(<span class="built_in">NSURL</span> *)location
 {
<span class="comment">//å­˜å‚¨æœ¬åœ°</span>

<span class="comment">//1.è·å–Documentsæ–‡ä»¶å¤¹è·¯å¾„ ï¼ˆä¸è¦å°†è§†é¢‘ã€éŸ³é¢‘ç­‰è¾ƒå¤§èµ„æºå­˜å‚¨åœ¨Cachesè·¯å¾„ä¸‹ï¼‰</span>
    *æ–¹æ³•ä¸€
    <span class="built_in">NSString</span> *documentsPath = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>,<span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>) lastObject];

    *æ–¹æ³•äºŒ
    <span class="built_in">NSFileManager</span> *manager = [<span class="built_in">NSFileManager</span> defaultManager];
    <span class="built_in">NSURL</span> * documentsDirectory = [fileManager URLsForDirectory:<span class="built_in">NSDocumentDirectory</span> inDomains:<span class="built_in">NSUserDomainMask</span>][<span class="number">0</span>];

   <span class="comment">//2.åˆ›å»ºèµ„æºå­˜å‚¨è·¯å¾„</span>
   <span class="built_in">NSString</span> *appendPath = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"/new.mp4"</span>];
   <span class="built_in">NSString</span> *file = [documentsPath stringByAppendingString:appendPath];

   <span class="comment">//3.å°†ä¸‹è½½å¥½çš„è§†é¢‘èµ„æºå­˜å‚¨åœ¨è·¯å¾„ä¸‹</span>

  <span class="comment">//åˆ é™¤ä¹‹å‰ç›¸åŒè·¯å¾„çš„æ–‡ä»¶</span>
    <span class="built_in">BOOL</span> remove  = [manager removeItemAtPath:file error:<span class="literal">nil</span>];

  <span class="comment">//å°†è§†é¢‘èµ„æºä»åŸæœ‰è·¯å¾„ç§»åŠ¨åˆ°è‡ªå·±æŒ‡å®šçš„è·¯å¾„</span>
    <span class="built_in">BOOL</span> success = [manager copyItemAtPath:location<span class="variable">.path</span> toPath:file error:<span class="literal">nil</span>];

    <span class="keyword">if</span> (success) {

  <span class="comment">//å›åˆ°ä¸»çº¿ç¨‹è¿›è¡Œæœ¬åœ°è§†é¢‘æ’­æ”¾</span>
    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^{

    <span class="comment">//åˆ›å»ºè§†é¢‘æ’­æ”¾çš„æœ¬åœ°è·¯å¾„</span>

    *** è¯·ä½¿ç”¨æ­¤æ–¹æ³•åˆ›å»ºæœ¬åœ°è·¯å¾„
    <span class="built_in">NSURL</span> *url = [[<span class="built_in">NSURL</span> alloc]initFileURLWithPath:file];

    *** æ­¤æ–¹æ³•åˆ›å»ºçš„è·¯å¾„æ— æ³•æ’­æ”¾ ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„è·¯å¾„
   <span class="comment">//NSURL *url2 = [[NSURL alloc]initWithString:file];</span>

    <span class="comment">//ç³»ç»Ÿçš„è§†é¢‘æ’­æ”¾å™¨</span>
    <span class="built_in">AVPlayerViewController</span> *controller = [[<span class="built_in">AVPlayerViewController</span> alloc]init];
    <span class="comment">//æ’­æ”¾å™¨çš„æ’­æ”¾ç±»</span>
    <span class="built_in">AVPlayer</span> * player = [[<span class="built_in">AVPlayer</span> alloc]initWithURL:url];

    controller<span class="variable">.player</span> = player;
    <span class="comment">//è‡ªåŠ¨å¼€å§‹æ’­æ”¾</span>
    [controller<span class="variable">.player</span> play];
    <span class="comment">//æ¨å‡ºè§†å±æ’­æ”¾å™¨</span>
    [<span class="keyword">self</span> presentViewController:controller animated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];


    });
}

 }
<span class="built_in">NSURLSessionDownloadTask</span>æ”¯æŒå–æ¶ˆä¸‹è½½ï¼Œå¯ä»¥åœ¨ä¸‹è½½è¿‡ç¨‹ä¸­éšæ—¶å–æ¶ˆç»§ç»­ä¸‹è½½ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å®ç°æ¢å¤ä¸‹è½½ã€‚
</code></pre><h4 id="å–æ¶ˆä¸‹è½½_cancelByProducingResumeData">å–æ¶ˆä¸‹è½½ cancelByProducingResumeData</h4><pre><code><span class="comment">//ç”¨å½“å‰NSURLSessionDownloadTaskå¯¹è±¡å»è°ƒç”¨å–æ¶ˆä¸‹è½½</span>

 [<span class="keyword">self</span><span class="variable">.downTask</span> cancelByProducingResumeData:
^(<span class="built_in">NSData</span> * _Nullable resumeData) {

 <span class="comment">//å…¨å±€å˜é‡ æ¥æ”¶å½“å‰ä¸‹è½½çš„èµ„æº</span>
  <span class="keyword">self</span><span class="variable">.data</span> = resumeData;
}
 <span class="comment">//å°†å½“å‰ä¸‹è½½ä»»åŠ¡ç½®ä¸ºç©º</span>
  <span class="keyword">self</span><span class="variable">.downTask</span> = <span class="literal">nil</span>;
</code></pre><h4 id="æ¢å¤ä¸‹è½½_downloadTaskWithResumeData">æ¢å¤ä¸‹è½½ downloadTaskWithResumeData</h4><pre><code><span class="comment">//æ¢å¤ä¸‹è½½ å®é™…ä¸Šæ˜¯å»ºç«‹äº†ä¸€ä¸ªæ–°çš„ä¸‹è½½ä»»åŠ¡ å»ç»§ç»­ä¹‹å‰çš„ä¸‹è½½</span>

<span class="built_in">self</span><span class="built_in">.</span>downTask = <span class="preprocessor">[</span><span class="built_in">self</span><span class="built_in">.</span>downLoadSession downloadTaskWithResumeData:<span class="built_in">self</span><span class="built_in">.</span><span class="built_in">data</span><span class="preprocessor">]</span><span class="markup">;

   //å¼€å¯ä»»åŠ¡     
  </span><span class="preprocessor">[</span><span class="built_in">self</span><span class="built_in">.</span>downTask resume<span class="preprocessor">]</span><span class="markup">;

}</span>
</code></pre><h4 id="è‡ªåŠ¨ç¼“å­˜">è‡ªåŠ¨ç¼“å­˜</h4><p>ä¸Šé¢è®²åˆ°çš„æ˜¯è‡ªå·±å»æ‰‹åŠ¨æ“æ§æ•´ä¸ªä¸‹è½½è¿‡ç¨‹ï¼Œé‚£ä¹ˆï¼Œå¾ˆå¤šä¼™ä¼´å°±ä¼šè®²è¿™æ ·æ˜¯ä¸æ˜¯å¤ªéº»çƒ¦äº†ã€‚å¦‚æœä½ äº†è§£äº†NSURLSessionçš„ç¼“å­˜ç­–ç•¥ï¼Œé‚£ä¹ˆï¼Œä½ å°±ä¼šå‘ç°ï¼Œæˆ‘ä»¬è¿™ä¹ˆå†™ç¡®å®æ˜¯å¤ªéº»çƒ¦äº†ï¼Œé‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±æ¥å­¦ä¹ ä¸€ä¸‹NSURsessionçš„è‡ªåŠ¨ç¼“å­˜ã€‚</p>
<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œå…ˆä»‹ç»ä¸€ä¸‹<code>NSURLRequestUseProtocolCachePolicy</code>çš„å‡ ç§ç¼“å­˜ç­–ç•¥ï¼š</p>
<ul>
<li><p>1&gt;NSURLRequestUseProtocolCachePolicy = 0, é»˜è®¤çš„ç¼“å­˜ç­–ç•¥ï¼Œ å¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼Œç›´æ¥ä»æœåŠ¡ç«¯è·å–ã€‚å¦‚æœç¼“å­˜å­˜åœ¨ï¼Œ<br>ä¼šæ ¹æ®responseä¸­çš„Cache-Controlå­—æ®µåˆ¤æ–­ä¸‹ä¸€æ­¥æ“ä½œï¼Œå¦‚: Cache-Controlå­—æ®µä¸ºmust-revalidata, åˆ™è¯¢é—®æœåŠ¡ç«¯è¯¥æ•°æ®æ˜¯å¦æœ‰æ›´æ–°ï¼Œæ— æ›´æ–°çš„è¯ç›´æ¥è¿”å›ç»™ç”¨æˆ·ç¼“å­˜æ•°æ®ï¼Œè‹¥å·²æ›´æ–°ï¼Œåˆ™è¯·æ±‚æœåŠ¡ç«¯.</p>
</li>
<li><p>2&gt;NSURLRequestReloadIgnoringLocalCacheData = 1, å¿½ç•¥æœ¬åœ°ç¼“å­˜æ•°æ®ï¼Œç›´æ¥è¯·æ±‚æœåŠ¡ç«¯.</p>
</li>
<li><p>3&gt;NSURLRequestIgnoringLocalAndRemoteCacheData = 4, å¿½ç•¥æœ¬åœ°ç¼“å­˜ï¼Œä»£ç†æœåŠ¡å™¨ä»¥åŠå…¶ä»–ä¸­ä»‹ï¼Œç›´æ¥è¯·æ±‚æºæœåŠ¡ç«¯.</p>
</li>
<li><p>4&gt;NSURLRequestReloadIgnoringCacheData = NSURLRequestReloadIgnoringLocalCacheData</p>
</li>
<li><p>5&gt;NSURLRequestReturnCacheDataElseLoad = 2, æœ‰ç¼“å­˜å°±ä½¿ç”¨ï¼Œä¸ç®¡å…¶æœ‰æ•ˆæ€§(å³å¿½ç•¥Cache-Controlå­—æ®µ), æ— åˆ™è¯·æ±‚æœåŠ¡ç«¯.</p>
</li>
<li><p>6&gt;NSURLRequestReturnCacheDataDontLoad = 3, æ­»æ´»åŠ è½½æœ¬åœ°ç¼“å­˜. æ²¡æœ‰å°±å¤±è´¥. (ç¡®å®šå½“å‰æ— ç½‘ç»œæ—¶ä½¿ç”¨).</p>
</li>
<li><p>7&gt;NSURLRequestReloadRevalidatingCacheData = 5, ç¼“å­˜æ•°æ®å¿…é¡»å¾—å¾—åˆ°æœåŠ¡ç«¯ç¡®è®¤æœ‰æ•ˆæ‰ä½¿ç”¨(è²Œä¼¼æ˜¯NSURLRequestUseProtocolCachePolicyä¸­çš„ä¸€ç§æƒ…å†µ)<br>å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å»è®¾ç½®ä¸åŒçš„ç¼“å­˜ç­–ç•¥ï¼Œè€Œé»˜è®¤çš„å°±æ˜¯å¦‚æœæœ‰ç¼“å­˜å°±é€šè¿‡ç¼“å­˜è·å–æ•°æ®ï¼Œæ²¡æœ‰ç¼“å­˜å°±å»è¯·æ±‚ç½‘ç»œæ•°æ®ã€‚<br>è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªè¯·æ±‚å›¾ç‰‡çš„ä¾‹å­ï¼Œæ¥çª¥æ¢ä¸€ä¸‹ç¥å¥‡çš„è‡ªåŠ¨ç¼“å­˜ã€‚</p>
</li>
</ul>
<p>ä»£ç ï¼š</p>
<pre><code>      <span class="comment">//åˆ›å»ºä¸€ä¸ªUIImageView+MyImageView.hçš„ç±»ç›®ï¼Œ</span>
  åœ¨<span class="variable">.h</span>æ·»åŠ ä¸€ä¸ªæ–¹æ³•
 - (<span class="keyword">void</span>)loadIamgeWithURL:(<span class="built_in">NSString</span> *)urlString
  <span class="comment">//åœ¨.må»å®ç°æ­¤æ–¹æ³•  </span>
 - (<span class="keyword">void</span>)loadIamgeWithURL:(<span class="built_in">NSString</span> *)urlString
{

<span class="comment">//åˆ›å»ºä¸‹è½½å›¾ç‰‡çš„url</span>
  <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:urlString];

<span class="comment">//åˆ›å»ºç½‘ç»œè¯·æ±‚é…ç½®ç±»</span>
  <span class="built_in">NSURLSessionConfiguration</span> * configuration = [<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration];

<span class="comment">//åˆ›å»ºç½‘ç»œä¼šè¯</span>
  <span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:configuration delegate:<span class="literal">nil</span> delegateQueue:[<span class="built_in">NSOperationQueue</span> new]];

<span class="comment">//åˆ›å»ºè¯·æ±‚å¹¶è®¾ç½®ç¼“å­˜ç­–ç•¥ä»¥åŠè¶…æ—¶æ—¶é•¿</span>
  <span class="built_in">NSURLRequest</span> *imgRequest = [<span class="built_in">NSURLRequest</span> requestWithURL:url cachePolicy:<span class="number">0</span> timeoutInterval:<span class="number">30.</span>f];
   <span class="comment">//*ä¹Ÿå¯é€šè¿‡configuration.requestCachePolicy è®¾ç½®ç¼“å­˜ç­–ç•¥</span>

<span class="comment">//åˆ›å»ºä¸€ä¸ªä¸‹è½½ä»»åŠ¡</span>
  <span class="built_in">NSURLSessionDownloadTask</span> *task = [session downloadTaskWithRequest:imgRequest completionHandler:^(<span class="built_in">NSURL</span> * _Nullable location, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error) {

  <span class="comment">//ä¸‹è½½å®Œæˆåè·å–æ•°æ® æ­¤æ—¶å·²ç»è‡ªåŠ¨ç¼“å­˜åˆ°æœ¬åœ°ï¼Œä¸‹æ¬¡ä¼šç›´æ¥ä»æœ¬åœ°ç¼“å­˜è·å–ï¼Œä¸å†è¿›è¡Œç½‘ç»œè¯·æ±‚</span>
  <span class="built_in">NSData</span> * data = [<span class="built_in">NSData</span> dataWithContentsOfURL:location];

  <span class="comment">//å›åˆ°ä¸»çº¿ç¨‹  </span>
   <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^{

  <span class="comment">//è®¾ç½®å›¾ç‰‡      </span>
   <span class="keyword">self</span><span class="variable">.image</span> = [<span class="built_in">UIImage</span> imageWithData:data];
 });


}];


<span class="comment">//å¯åŠ¨ä¸‹è½½ä»»åŠ¡</span>
 [task resume];
</code></pre><p>  }<br>é€šè¿‡è¿™ç§ç¼“å­˜ç­–ç•¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°å›¾ç‰‡ä¸‹è½½å¹¶è‡ªåŠ¨ç¼“å­˜ï¼Œå½“æˆ‘ä»¬éœ€è¦å†æ¬¡ä½¿ç”¨æ­¤èµ„æºçš„æ—¶å€™ï¼Œå®ƒå°±ä¼šè‡ªåŠ¨å»æœ¬åœ°ç¼“å­˜æŸ¥æ‰¾æ˜¯å¦æœ‰å·²ç»ä¸‹è½½å¥½çš„å›¾ç‰‡èµ„æºï¼Œå¦‚æœæœ‰å°±ä¼šç›´æ¥å»æœ¬åœ°çš„ï¼Œä»è€Œä¸éœ€è¦å†å»è¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚å¯ä»¥åœ¨ä¸‹è½½å®Œæˆåï¼Œå°†ç½‘ç»œæ–­å¼€è¿›è¡Œæµ‹è¯•ã€‚<br>æ€»ç»“<br>æœ¬æ¬¡ä¸»è¦æ˜¯è®²è§£äº†NSURLSessionçš„ä¸‹è½½ï¼Œä»¥åŠè‡ªåŠ¨ç¼“å­˜ç­–ç•¥ã€‚å®ƒçš„åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œè¿˜æœ‰å¾ˆå¤šæ²¡æ¥å¾—åŠç»†ç»†ç ”ç©¶ï¼Œå¦‚æœä½ ä¹Ÿå–œæ¬¢å®ƒğŸ˜ï¼Œé‚£å°±æŠ“ç´§æ—¶é—´å»ç ”ç©¶å§~</p>
</span>
      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/10/30/å¦‚ä½•åˆ¶ä½œæƒ³æ·˜å®å£ä»¤ä¸€æ ·çš„é“¾æ¥/" rel="prev">å…³äºiOSçš„å‰ªè´´æ¿åŸºæœ¬çŸ¥è¯†</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/08/15/Socketç¼–ç¨‹/" rel="next">Socketç¼–ç¨‹</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


            </div>

            

            
              <div class="comments" id="comments">
                
              </div>
            
        </div>

        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/avatar.jpg" alt="å¼ å¤©ç¦" itemprop="image"/>
          <p class="site-author-name" itemprop="name">å¼ å¤©ç¦</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">37</span>
              <span class="site-state-item-name">æ—¥å¿—</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">7</span>
              <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">24</span>
              <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#æ‰‹åŠ¨ä¸‹è½½è§†é¢‘"><span class="nav-number">1.</span> <span class="nav-text">æ‰‹åŠ¨ä¸‹è½½è§†é¢‘</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æ­¥éª¤ï¼š"><span class="nav-number">2.</span> <span class="nav-text">æ­¥éª¤ï¼š</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å£°æ˜ç›¸å…³å±æ€§"><span class="nav-number">3.</span> <span class="nav-text">å£°æ˜ç›¸å…³å±æ€§</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#é…ç½®ç›¸å…³å‚æ•°å¹¶ä¸‹è½½"><span class="nav-number">4.</span> <span class="nav-text">é…ç½®ç›¸å…³å‚æ•°å¹¶ä¸‹è½½</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å®ç°ä»£ç†æ–¹æ³•"><span class="nav-number">5.</span> <span class="nav-text">å®ç°ä»£ç†æ–¹æ³•</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å–æ¶ˆä¸‹è½½_cancelByProducingResumeData"><span class="nav-number">6.</span> <span class="nav-text">å–æ¶ˆä¸‹è½½ cancelByProducingResumeData</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æ¢å¤ä¸‹è½½_downloadTaskWithResumeData"><span class="nav-number">7.</span> <span class="nav-text">æ¢å¤ä¸‹è½½ downloadTaskWithResumeData</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#è‡ªåŠ¨ç¼“å­˜"><span class="nav-number">8.</span> <span class="nav-text">è‡ªåŠ¨ç¼“å­˜</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="copyright" >
  
  &copy; &nbsp;  2014 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">å¼ å¤©ç¦</span>
</div>

<div class="powered-by">
  ç”± <a class="theme-link" href="http://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



        </div>
    </footer>

    <div class="back-to-top"></div>
</div>

<script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    
    

  


  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.4"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.4"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.4" id="motion.global"></script>



  <script type="text/javascript" src="/js/search-toggle.js"></script>


  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.4" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



<script type="text/javascript">
    $(document).ready(function () {
        if (CONFIG.sidebar === 'always') {
            displaySidebar();
        }
    });
</script>








<!-- lazyload -->
<script type="text/javascript" src="/js/lazyload.js"></script>
<script type="text/javascript">
    jQuery(function () {
        jQuery("#posts img").lazyload({
            placeholder: "/images/loading.gif",
            effect: "fadeIn"
        });
    });
</script>
</body>
</html>
